<!--
@license
Copyright (c) 2015 The LANcie commission of W.I.S.V `Christiaan Huygens`. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/WISVCH/LANcie/blob/master/LICENSE
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<link rel="import" href="lancie-tickets.html">
<link rel="import" href="lancie-ticket-basket.html">
<link rel="import" href="lancie-terms-of-service-text.html">
<link rel="import" href="../lancie-my-area/profile-edit-form.html">
<link rel="import" href="../lancie-storage/lancie-order-storage.html">
<link rel="import" href="../lancie-login/lancie-login.html">

<dom-module id="lancie-ticket-page">
  <template>
    <style is="custom-style" include="paper-material-styles"></style>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        padding: 16px;
      }

      paper-tab {
        background-color: var(--primary-color);
        color: var(--secondary-color);
        --paper-tabs-content: {
          @apply --layout-horizontal;
          @apply --layout-center-center;
          font-size: 16px;
        }
      }

      paper-progress {
        width: 100%;
        height: 8px;
        --paper-progress-active-color: var(--secondary-color);
        --paper-progress-container-color: var(--primary-color);
      }

      .paper-material {
        background-color: white;
        max-width: 1200px;
        margin: 0 auto;
      }

      iron-pages {
        padding: 16px;
      }

      .buttons {
        padding: 8px;
        border-top: solid 1px #e8e8e8;
      }
      
      .next-button {
        background-color: var(--primary-color);
        color: var(--secondary-color);
      }

      .next-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
        cursor: auto;
        pointer-events: none;
      }

      @media(max-width: 500px) {
        :host{
          padding: 0;
        }
      }

      /*
      * Safari hack
      * Makes flex wrapping work
      */

      .flex,
      .flex-1,
      .flex-2,
      .flex-3 {
        flex-basis: 400px;
      }
      /*End Safari hack*/
    </style>

    <lancie-order-storage id="orderStorage" on-order="storeStorageOrder"></lancie-order-storage>

    <lancie-ajax auto-fire skip-token id="ajaxAvailable" refurl="tickets/available" on-lancie-ajax="onAvailableTickets"></lancie-ajax>
    <lancie-ajax id="ajaxCoupleOrder" refurl="orders/[[basket.id]]/assign" method="POST" on-lancie-ajax="onCoupleOrder"></lancie-ajax>
    <lancie-ajax id="ajaxCheckout" refurl="orders/[[basket.id]]/checkout" method="POST" on-lancie-ajax="onCheckout"></lancie-ajax>
    <lancie-ajax auto-fire refurl="users/current/orders/open" on-lancie-ajax="onOpenOrder"></lancie-ajax>

    <div class="paper-material" elevation="1" on-next="next">
      <paper-tabs id="step" selected="{{selected}}">
        <paper-tab disabled>Tickets</paper-tab>
        <paper-tab disabled>Login</paper-tab>
        <paper-tab disabled>Profile</paper-tab>
        <paper-tab disabled>Terms &amp; Conditions</paper-tab>
      </paper-tabs>
      <paper-progress min="-1" value="[[selected]]" max="3"></paper-progress>

      <iron-pages selected="[[selected]]">

        <div class="layout horizontal wrap" on-set-basket="storeBasket">
          <lancie-tickets class="flex-3" tickets="[[availableTickets]]" basket="[[basket]]"></lancie-tickets>
          <lancie-ticket-basket class="flex-2" basket="[[basket]]" user="{{user}}"></lancie-ticket-basket>
        </div>

        <lancie-login id="login" on-logged-in="next"></lancie-login>

        <div>
          <h2>Fill in your profile</h2>
          <profile-edit-form id="profileForm" user="{{user}}" on-profile-submitted="profileConfirmed"></profile-edit-form>
        </div>

        <div>
          <h2>Terms and conditions</h2>
          <lancie-terms-of-service-text></lancie-terms-of-service-text>
        </div>

      </iron-pages>
      <div class="buttons layout horizontal end-justified">
        <paper-button hidden="[[_backDisabled(selected)]]" on-tap="backToStart">back to tickets</paper-button>
        <paper-button class="next-button" disabled="[[_isOrderEmpty(basket)]]" raised on-tap="next">[[_getButtonText(selected)]]</paper-button>
      </div>
    </div>

  </template>
  <script>
  (function () {
  'use strict';

  Polymer({
    is: 'lancie-ticket-page',
    properties: {
      user: Object,
      basket: {
        type: Object,
        value: {},
        notify: true,
      },
      availableTickets: {
        type: Object,
        value: [],
      },
      selected: {
        type: Object,
        value: 0
      }
    },
    observers: [
      '_assignOrder(user, basket)'
    ],

    next: function() {
      if (this.selected === 0) {
        if (!this.user) {
          this.selectTab(1);
        } else {
          this.selectTab(2);
        }
      } else if (this.selected === 1 && !this.user) {
          this.$.login.submit();
      } else if (this.selected === 2 && this.user) {
        this.$.profileForm.validateAndSubmit();
      } else if (this.selected === 3) {
        this.$.ajaxCheckout.generateRequest();
      } else {
        this.selectTab(0);
      }
    },

    selectTab: function(tab) {
      if (tab === 2) {
        this.$.profileForm.validate();
      }
      this.selected = tab;
    },

    backToStart: function() {
      this.selectTab(0);
    },

    profileConfirmed: function() {
      this.selectTab(3);
    },

    onAvailableTickets: function (e, request) {
      if (request.succeeded) {
        this.availableTickets = request.response;
      } else {
        this.fire('refreshToast');
      }
    },

    storeBasket: function (e) {
      this.set('basket', e.detail.basket);
    },

    onCheckout: function(e, request) {
      if (request.succeeded) {
        // This sets the url to the mollie address of the order.
        window.location.href = request.response.object;
      } else {
        this.fire('refreshToast');
      }
    },

    storeStorageOrder: function (e) {
      if (!this.basket.id) {
        this.basket = e.detail;
      }
    },

    onOpenOrder: function (e, request) {
      // Don't set basket when there is a new basket
      if (!!this.basket.tickets) {
        return;
      }
      if (request.succeeded) {
        if (request.response.length > 0) {
          this.basket = request.response[0];
        }
      }
    },

    onCoupleOrder: function (e, request) {
      if (request.succeeded) {
        this.basket = request.response.object;
        this.$.orderStorage.removeStorage();
        if (this.selected === 1) {
          this.selectTab(2);
        }
      } else {
        if (request.status === 409) {
          this.fire('toast', { text: 'Unable to couple the order to your account. Order is already linked.' });
          this.$.orderStorage.removeStorage();
          this.set('basket.tickets', []);
        } else {
          this.basket.status = 'ANONYMOUS';
          this.$.orderStorage.storeOrderId(this.basket.id);
          this.fire('toast', { text: 'Unable to couple the order to your account. Try refreshing the page.' });
        }
      }
    },

    /*
      If the order is set and the user is logged in, attempt to couple the order to the user.
      If the user is not logged in and the order is not yet stored, store the orderId.
    */
    _assignOrder: function (user, basket) {
      if (basket.status === 'ANONYMOUS' && !!user) {
        basket.status = 'ASSIGNED';
        this.$.ajaxCoupleOrder.generateRequest();
      } else if (basket.status === 'ANONYMOUS' && !this.$.orderStorage.orderStored()) {
        this.$.orderStorage.storeOrderId(basket.id);
      }
    },

    _getButtonText(selected) {
      if (selected === 3) {
        return 'agree & pay';
      }
      return 'next';
    },

    _backDisabled(selected) {
      return selected === 0;
    },

    _isOrderEmpty(basket) {
      if (basket.tickets) {
        return basket.tickets.length <= 0;
      }
      return true;
    },
  });
  })();
  </script>
</dom-module>
