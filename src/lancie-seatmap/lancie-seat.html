<!--
@license
Copyright (c) 2015 The LANcie commission of W.I.S.V `Christiaan Huygens`. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/WISVCH/LANcie/blob/master/LICENSE
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/lancie-dialog/lancie-dialog.html">
<link rel="import" href="../../bower_components/lancie-error/lancie-error.html">

<dom-module id="lancie-seat">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
    :host {
      display: block;
      position: relative;
      width: 48px;
      height: 72px;
      margin-bottom: 5px;
    }

    [hidden] {
      display: none !important;
    }

    .seat {
      height: 100%;
      margin: 4px;
      border-radius: 2px;
      background: #fafafa;
      box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .green {
      background-color: var(--paper-green-500);
    }

    .yellow {
      background-color: var(--paper-yellow-500);
    }

    .red {
      background-color: var(--paper-red-500);
      cursor: default !important;
    }

    .gray {
      background-color: var(--paper-grey-500);
      cursor: default !important;
    }

    .blue {
      background-color: var(--paper-blue-500);
    }
    </style>
    <div id="seat" class$="seat layout center center-justified horizontal flex {{_calculateClass(user, tickets, seat, filter)}}" on-tap="showSeatDialog">
      <div>{{seat.seatNumber}}</div>
      <paper-tooltip for="seat" animationDelay="0">{{_getTooltipText(seat)}}</paper-tooltip>
    </div>
  </template>
  <script>
  'use strict';

  (function() {
    Polymer({
      is: 'lancie-seat',
      behaviors: [
        Polymer.PaperButtonBehavior
      ],
      properties: {
        user: {
          type: Object,
          value: {}
        },
        seat: Object,
        tickets: {
          type: Array,
          value: function() {
            return [];
          }
        },
        filter: {
          type: String,
          value: ''
        },
        fixed: {
          type: Boolean,
          value: false
        }
      },
      showSeatDialog: function() {
        if (this.seat.locked || this.seat.ticket && this.seat.ticket.owner.reference !== this.user.reference) {
          return;
        }
        this.fire('request-seat-reserve', {'seatToReserve': this.seat});
      },
      _calculateClass: function(user, teamTickets, seat, filter) {
        if (seat.ticket && seat.ticket.owner.profile.displayName && filter !== '' && seat.ticket.owner.profile.displayName.toLowerCase().indexOf(filter.toLowerCase()) > -1) {
          return 'blue'; // Filter (search bar)
        }
        if (seat.locked) {
          return 'gray'; // Reserved
        }
        if (seat.ticket && user.reference === seat.ticket.owner.reference) {
          return 'green'; // Your own seat!
        }
        let teamMembers = teamTickets.map(function(ticket) {
          return ticket.owner.reference;
        });
        if (seat.ticket && teamMembers.includes(seat.ticket.owner.reference)) {
          return 'yellow'; // A team member's seat
        }
        if (seat.ticket && seat.ticket.owner.reference !== user.reference) {
          return 'red'; // Taken
        }
        if (!seat.ticket && !seat.locked) {
          return ''; // Free
        }
        return 'red'; // No match any of the above, make red just in case
      },
      _getTooltipText: function(seat) {
        if (seat.locked) {
          return 'Reserved';
        }
        if (seat.ticket) {
          return seat.ticket.owner.profile.displayName;
        }
        if (!seat.locked && !seat.ticket) {
          return 'Free';
        }
        return 'Taken'; // Backup, if for some reason an invalid state is encountered (it is probably red then)
      }
    });
  })();
  </script>
</dom-module>
