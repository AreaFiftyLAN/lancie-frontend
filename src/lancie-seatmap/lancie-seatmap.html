<!--
@license
Copyright (c) 2015 The LANcie commission of W.I.S.V `Christiaan Huygens`. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/WISVCH/LANcie/blob/master/LICENSE
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="lancie-seat-group.html">
<link rel="import" href="lancie-seat.html">


<dom-module id="lancie-seatmap">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>
    <style>
    :host {
      display: block;
      padding: 32px;
    }

    [hidden] {
      display: none !important;
    }

    .seatmap-row {
      padding: 16px;
    }

    .grouplabel {
      width: 64px;
      color: var(--secondary-color);
      font-size: 32px;
      font-weight: bold;
      background: var(--primary-color);
      box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                  0 1px 5px 0 rgba(0, 0, 0, 0.12),
                  0 3px 1px -2px rgba(0, 0, 0, 0.2);
    }
    </style>

    <lancie-ajax auto id="ajaxGetAllSeats" refurl="seats" on-response="onGetAllSeats"></lancie-ajax>
    <lancie-ajax auto id="ajaxGetTeamTickets" refurl="tickets/teammembers" on-response="onGetTeamTickets"></lancie-ajax>
    <lancie-ajax id="ajaxReserveSeat" method="POST" on-response="onReserveSeat"></lancie-ajax>

    <paper-input label="Search user" value="{{filterUser}}"></paper-input>
    <div class="layout horizontal">
      <div>
       <img src="/images-optimized/seatmap/stage.png">
      </div>
      <div class="layout seats flex-2 seatgroup vertical">
        <template is="dom-repeat" items='["A", "B", "C", "D", "E"]'>
          <div class="layout flex horizontal seatmap-row">
            <div class="grouplabel layout center center-justified horizontal">{{item}}</div>
            <lancie-seat-group class="layout flex vertical" filter="{{filterUser}}" group="{{item}}" seats="{{_getSeatGroup(seats, item)}}" tickets="{{tickets}}" user="{{user}}" fixed="{{fixed}}"></lancie-seat-group>
          </div>
        </template>
      </div>
      <div class="layout seats flex-2 seatgroup vertical">
        <template is="dom-repeat" items='["F", "G", "H", "I", "J"]'>
          <div class="layout flex horizontal seatmap-row">
            <lancie-seat-group class="layout flex vertical" filter="{{filterUser}}"  group="{{item}}" seats="{{_getSeatGroup(seats, item)}}" tickets="{{tickets}}" user="{{user}}" fixed="{{fixed}}"></lancie-seat-group>
            <div class="grouplabel layout center center-justified horizontal">{{item}}</div>
          </div>
        </template>
      </div>
      <div>
        <img src="/images-optimized/seatmap/lounge.png">
      </div>
    </div>

    <lancie-dialog id="seatDialog">
      <h2>Seat reservation</h2>
      <div class="dialog-content">
        <lancie-error id="error"></lancie-error>
        <div hidden$="{{!_checkExists(tickets)}}">
          Select the user to reserve this seat for:
          <paper-listbox id="listbox">
            <template is="dom-repeat" items="{{tickets}}">
              <paper-item ticket="{{item.id}}">{{item.owner.profile.displayName}}</paper-item>
            </template>
          </paper-listbox>
        </div>
        <div hidden$="{{_checkExists(tickets)}}">
          You need at least one ticket to reserve a seat!
        </div>
      </div>
      <div class="dialog-actions">
        <paper-button dialog-dismiss>Close</paper-button>
        <paper-button on-tap="reserveSeat" hidden$="{{!_checkExists(tickets)}}">Reserve seat</paper-button>
      </div>
    </lancie-dialog>

    <paper-toast id="reserveSeatSuccessToast" text="Seat reservation successfull!" duration="3000"></paper-toast>
    <paper-toast id="getAllSeatsErrorToast" text="Something went wrong, please refresh the page!" duration="3000"></paper-toast>
    <paper-toast id="getAllTicketsErrorToast" text="Something went wrong, please refresh the page!" duration="3000"></paper-toast>
  </template>
  <script>
  'use strict';
  (function() {
    Polymer({
      is: 'lancie-seatmap',
      properties: {
        user: Object,
        seats: {
          type: Array,
          value: function() {
            return [];
          }
        },
        seat: Object,
        tickets: {
          type: Array,
          value: function() {
            return [];
          }
        },
        fixed: {
          type: Boolean,
          notify: true
        }
      },
      listeners: {
        'openDialog': 'open'
      },
      refreshSeats: function() {
        this.$.reserveSeatSuccessToast.show();
        this.$.ajaxGetAllSeats.generateRequest();
      },
      onGetAllSeats: function(e, request) {
        if (request.succeeded) {
          var seats = [];
          var groups = 'ABCDEFGHIJ';
          for (var i = 0; i < groups.length; i++) {
            seats[groups.charAt(i)] = request.response.seatmap[groups.charAt(i)].sort(function(a, b) {
              return a.seatNumber - b.seatNumber;
            });
          }
          this.seats = seats;
        } else {
          this.$.getAllSeatsErrorToast.show();
        }
      },
      onGetTeamTickets: function(e, request) {
        if (request.succeeded) {
          this.tickets = request.response;
        } else {
          this.$.getAllTicketsErrorToast.show();
        }
      },
      reserveSeat: function() {
        this.$.error.clear();
        if (!this.$.listbox.selectedItem) {
          this.$.error.setError('Please select a user.');
          return;
        }
        this.$.ajaxReserveSeat.params = {
          'ticketId': this.$.listbox.selectedItem.ticket
        };
        this.$.ajaxReserveSeat.refurl = 'seats/' + this.seat.seatGroup + '/' + this.seat.seatNumber;
        this.$.ajaxReserveSeat.generateRequest();
        this.$.seatDialog.close();
      },
      onReserveSeat: function(e, response) {
        if (response.succeeded) {
          this.$.listbox.selected = undefined;
          this.refreshSeats();
        } else {
          this.reservationError = true;
          if (response.request.status === 409) {
            this.$.error.setError('Seat is already taken.');
          } else {
            this.$.error.setError('Something went wrong, please refresh and try again.');
          }
        }
      },
      open: function(listenerEvent) {
        this.seat = listenerEvent.detail;
        this.$.seatDialog.open();
      },
      _getSeatGroup: function(seats, group) {
        return seats[group];
      },
      _checkExists: function(tickets) {
        return tickets.length > 0;
      },
    });
  })();
  </script>
</dom-module>
