<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="lancie-login-card.html">
<link rel="import" href="lancie-ajax.html">
<link rel="import" href="lancie-login-dialog.html">

<dom-module id="lancie-login-check">
  <template>

    <template is="dom-if" if="{{canAccess(user, nologin)}}" restamp=true>
      <content></content>
    </template>

    <template is="dom-if" if="{{!canAccess(user, nologin)}}">
      <lancie-login-card on-logged-in="storeUser"></lancie-login-card>
    </template>

    <lancie-login-dialog id="loginDialog" on-logged-in="storeUser"></lancie-login-dialog>

    <lancie-ajax id="ajax"></lancie-ajax>
  </template>
  <script>
  'use strict';
  var user = '';

  (function() {

    var checks = [];

    Polymer({
      is: 'lancie-login-check',
      properties: {
        user: {
          type: Object,
          notify: true,
          value: function() {
            return user;
          }
        },
        nologin: {
          type: Boolean,
          value: false
        },
      },

      ready: function() {
        checks.push(function(newUser) {
          this.user = newUser;
        }.bind(this));

        // Add eventlistener on loginDialog to catch logged-in event in entire element
        // this.$.loginDialog.addEventListener('logged-in', function(e) {
          // this.storeUser(e, e.detail);
        // });

        // Add eventlistener to catch login dialog open request
        this.addEventListener('login-dialog', function() {
          this.$.loginDialog.open();
        });
      },

      canAccess: function(user, nologin) {
        return nologin || user !== '';
      },

      storeUser: function(e, detail) {
        this.user = detail.user;
        this.$.ajax.injectToken(detail.token);

        this.fire('store-token', {token: detail.token});

        for (var i = 0; i < checks.length; i++) {
          checks[i](this.user);
        }
      }
    });
  })();
  </script>
</dom-module>
