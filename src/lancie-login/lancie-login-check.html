<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="lancie-login-card.html">

<dom-module id="lancie-login-check">
  <template>

    <template is="dom-if" if="{{canAccess(user, nologin)}}" restamp=true>
      <content></content>
    </template>

    <template is="dom-if" if="{{!canAccess(user, nologin)}}">
      <lancie-login-card on-logged-in="storeUser"></lancie-login-card>
    </template>

    <lancie-ajax id="ajax"></lancie-ajax>
  </template>
  <script>
  'use strict';
  var user = '';

  (function() {

    var checks = [];

    Polymer({
      is: 'lancie-login-check',
      properties: {
        user: {
          type: Object,
          notify: true,
          value: function() {
            return user;
          }
        },
        nologin: {
          type: Boolean,
          value: false
        },
        tokenStoreFunc: Function,
      },

      ready: function() {
        checks.push(function(newUser) {
          this.user = newUser;
        }.bind(this));
      },

      canAccess: function(user, nologin) {
        return nologin || user !== '';
      },

      storeUser: function(e, detail) {
        this.user = detail.user;
        user = this.user;
        this.$.ajax.injectToken(detail.token);

        this.fire('store-token', {token: detail.token});

        for (var i = 0; i < checks.length; i++) {
          checks[i](user);
        }
      }
    });
  })();
  </script>
</dom-module>
