<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/lancie-ajax/lancie-ajax.html">
<link rel="import" href="../lancie-storage/lancie-auth-storage.html">

<dom-module id="lancie-logout-button">
<template>
  <style>
    :host {
      display: block;
      margin: 8px;
    }

    paper-button {
      background-color: var(--primary-color);
      color: var(--secondary-color);
      font-weight: 450;
    }
  </style>

  <lancie-ajax id="ajaxLogout" refurl="logout" method="POST" on-lancie-ajax="onLogoutResponse"></lancie-ajax>

  <paper-button raised on-tap="tryLogout">Logout</paper-button>

</template>
<script>
  class LancieLogoutButton extends Polymer.Element {
    static get is() {
      return 'lancie-logout-button';
    }

    tryLogout() {
        this.$.ajaxLogout.generateRequest();
    }

    onLogoutResponse(e, request) {
      if (request.succeeded) {
          this.dispatchEvent(new CustomEvent('clear-token', {
              bubbles: true,
              composed: true
          }));
          this.dispatchEvent(new CustomEvent('user-changed', {
              detail: {value: {}},
              bubbles: true,
              composed: true
          }));
          this.dispatchEvent(new CustomEvent('toast', {
            detail: 'You successfully logged out',
            bubbles: true,
            composed: true
          }));
          window.sessionStorage.clear();
          // note: some extensions block this
          window.location.replace("/");
        } else {
          this.dispatchEvent(new CustomEvent('toast', {
            detail: 'You are not logged in',
            bubbles: true,
            composed: true
          }));
        }
    }
  }

  customElements.define(LancieLogoutButton.is, LancieLogoutButton);
  </script>
</dom-module>
