<!--
@license
Copyright (c) 2015 The LANcie commission of W.I.S.V `Christiaan Huygens`. All rights reserved.
This code may only be used under the BSD style license found at https://github.com/WISVCH/LANcie/blob/master/LICENSE
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="lancie-ticket-list.html">
<link rel="import" href="lancie-ticket-iron-block.html">
<link rel="import" href="lancie-ticket-block.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">

<dom-module id="lancie-ticket-page">
  <link rel="import" type="css" href="lancie-ticket-page.css">

  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>

    <lancie-ajax id="ajax" refurl="orders/{{order.id}}/checkout" on-response="goToPayment"></lancie-ajax>
    <lancie-ajax auto id="tickets" refurl="tickets/available" on-response="loadTickets"></lancie-ajax>
    <lancie-ajax auto refurl="users/current/orders/open" method="GET" on-response="getOpenOrder"></lancie-ajax>
    <template is="dom-if" if="{{canOrderTickets}}" restamp="true">
      <iron-media-query query="(min-width: 1018px)" query-matches="{{medium}}"></iron-media-query>
      <lancie-section type="primary full" header="Ticket sale - AreaFiftyLAN 2016, 03 - 04 - 05 June">
        <lancie-ticket-selector id="list" tickets="{{order.tickets}}" class="layout horizontal flex">
          <div class$="{{_setLayout(medium)}}">
            <div class="layout horizontal flex">
              <paper-card heading="Tickets">
                <div class="card-content layout horizontal wrap">
                  <template is="dom-repeat" items="{{availableTickets}}">
                    <lancie-ticket-iron-block order="{{order}}" ticket="{{item}}" color="{{_color(index)}}"></lancie-ticket-iron-block>
                  </template>
                </div>
              </paper-card>
            </div>
            <div class="layout horizontal cart start">
              <paper-card heading="Cart" style="width: 400px;">
                <div class="card-content" style="padding: 0;">
                  <lancie-ticket-list order="{{order}}"></lancie-ticket-list>
                </div>
                <template is="dom-if" if="{{order.amount > 0}}">
                  <div class="card-actions">
                    <strong>Total amount:</strong> <span>&euro; [[_formatPrice(order.amount)]]</span>
                  </div>
                </template>
                <div class="card-actions">
                  <paper-button raised on-tap="payOrder" disabled="{{hasNoTickets}}">Check out</paper-button>
                  <br />
                  <br />
                  <small>Note: If you do not pay the tickets within 30 minutes, the order will be removed.</small>
                </div>
              </paper-card>
            </div>
          </div>
        </lancie-ticket-selector>
      </lancie-section>
    </template>
    <paper-dialog id="termsofservice" on-iron-overlay-opened="patchOverlay" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
      <h2>Terms and conditions</h2>
      <paper-dialog-scrollable>
        <h3>General Terms and Conditions</h3>
        <h3>0 Definitions</h3>
        This document contains the general terms and conditions for “Area5LAN”, taking place from the 3rd of June until the 5th of June 2016, from now on referenced to as “the event”. The event is established by “Student Association for Mathematics and Computer Science ‘Christiaan Huygens’” through the “LanCie Committee 2015-2016”, these two parties are from now on referenced to as “the organization”. Any other individual that is legally present at, or has the authority to be present at the event while not being part of the organization is considered to be a participant, if not stated otherwise. Every individual at the event must follow these terms and conditions.    
        <h3>1 Validity</h3>
        The organization reserves the right to modify these general terms and conditions until the start date of the event without any form of report of reason. The Dutch legislation is in effect at all times. Any violation of the terms and conditions will be punished by a fee of an appropriate amount, determined by the organization unless specified otherwise.
        <h3>2 Tickets</h3>
        <h4>2.1 Purchasing tickets</h4>
        Official tickets can only be purchased through the official website: https//areafiftylan.nl. Tickets retrieved through any other source will not be accepted. Purchasing a ticket automatically means the buyer accepts these terms and conditions. Any data given will not be shared with third parties. The tickets will be on sale until at the latest 1 (one) week before the actual event. After this, the ticket sale will be closed.
        <h4>2.2 Members of W.I.S.V. Christiaan Huygens</h4>
        The event is, among others, hosted by the “Student Association for Mathematics and Computer Science Christiaan Huygens”. All members of this study association who wish to attend the event, can purchase a ticket for a lower price. Please note that your membership will be verified upon entering the event. If it appears you are not a member, but you still purchased a members-ticket, you will be asked to still pay the remaining costs of the ticket for a non-CH member. If you do not agree, you will be asked to leave the event.
        <h4>2.3 Tickets are sold out</h4>
        If tickets appear to be sold out, one can be put on a waiting list. There will be no second round of the ticket sale, meaning the waiting list is the only way of getting a ticket. Once a ticket is available, you will be noted of the person trying to sell the ticket. The ticket resale will only take place between the buyer and the seller. The organization will do nothing more than providing the buyers contact info.
        <h4>2.2 Resale of tickets</h4>
        The reseller may charge the new buyer at maximum the original price; no profits must be made. The reseller is responsible for this exchange, including providing the organization with the right data.
        <h3>3 Participation</h3>
        <h4>3.1 Legal presence</h4>
        Upon entering the event, every participant must be in possession of an official ticket and any of the following forms of identification: id card, passport, driver's license. If the information on the ticket is not identical to the relevant information on the participant’s form of identification, the participant will be asked to leave the event. If the participant is younger than 18 years, the participant should be able to present any form of authorization by caretakers/parents upon entry to the event. If the participant is asked to present the authorization again at a later point during the event, the participant should be able to do so. Once the participant’s entry is approved, a wristband is received. This wristband must be worn at all times throughout the participant’s stay at the event.
        <h4>3.2 Illegal presence</h4>
        During the event a participant’s proof of attendance is the wristband given at arrival. If this wristband is lost or damaged in an unrecognizable way, a new one must be obtained by rerunning the registration process. Without the wristband the organization is allowed to remove the person in question from the event and charge him/her with a fee of at least €100,-.
        <h4>3.3 Being able to fully participate</h4>
        In case of bringing an own PC, the participant makes sure no illegal or harmful software is installed which can be spread through the network at the event. This kind of software will not be brought in externally as well. The participant will make sure to have an up to date security system installed, e.g. firewall and virusscanner, as the organization will not take any responsibility for any damage caused or taken.
        <h3>4 Liability</h3>
        Only the participant is responsible for his/her personal and intellectual properties. Any instructions given by the organization must be followed. In case of unacceptable behavior, the participant may be given a warning or be asked to leave immediately. A warning is given once, thereafter follows removal from the event. If a participant is asked to leave the event, no refunds will be given.
        <h3>5 Illegal activities</h3>
        No weapons or other dangerous objects are allowed at the event. Hacking or spreading hazardous software, intentional or not, will result in removal of the event. If a participant is caught cheating in any way, the participant may not participate in any tournaments, including the current tournament. The participant will be removed from the event and will be banned from any future editions of the event. A participant will always cooperate with the organization when they are investigating sincere violations of the general terms and conditions. Otherwise, the participant will be removed from the event.
        <h3>6 Behavior at the event</h3>
        <h4>6.1 Undesired behavior</h4>
        The participant will not behave in a way that is unpleasant for the surroundings. Deliberately causing harm to another person or this person's property will not be tolerated and may result in removal from the event. In case of a fight, all responsible parties will be removed from the event, without negotiation. The participant will not cause noise disturbance, thus meaning speaker sets and other comparable objects are not allowed at the event. 
        <h4>6.2 Waste</h4>
        Any garbage will be disposed of in the appropriate bins or bags. A participant will not litter or leave anything behind. Such actions will result in an appropriate fee as determined by the organization.
        <h4>6.3 Promoting during the event</h4>
        <h5>6.3.1 Advertising</h5>
        No advertising is allowed without the organization’s permission. If the participant has a sponsor or other party which would like to use the event as promotion site, please contact the organization beforehand. If unauthorized advertising is discovered, the person responsible will be asked to leave the event and demanded a fine of at least €250,-. In case of unauthorized flyering, a fine of €10,- per flyer will be demanded.
        <h5>6.3.2 Sales</h5>
        No sales, which are not commissioned by the organization, are allowed at the event. If a participant is found selling products in any form, the participant will be removed from the event and a fine of at least  €500,- will be demanded as compensation. 
        <h5>6.3.3 Surveys</h5>
        Surveying at the event is allowed after the organization has given its permission. If unauthorized surveying is detected, the person responsible will be removed from the event. In case this person is a participant, the participant will be given a warning.
        <h4>6.4 Alcohol/narcotics</h4>
        Consumption of alcohol is only permitted above the age of 18. The participant will drink with moderation, if not, the participant will be removed from the event. Soft- and harddrugs, medication excluded, are not permitted at the event. Smoking is only permitted outside.
        <h3>7 Food and beverages</h3>
        <h4>7.1 Bringing food and drinks to the event</h4>
        During the event meals and beverages will be provided (see 7.2). Participants may therefore bring limited food and drinks of their own.
        <h4>7.2 Amenities regarding food and beverages</h4>
        During the official duration of the event, the organization will provide the participants with up to three meals a day. These meals are included in the price of the ticket thus the participant will not be charged extra. Please refer to the official timetable for more information on how many and which meals will be provided. Outside these meals, participants may refrain to their own limited supply, free snacks and beverages provided by the organization or purchase meals and drinks supplied by the organization of the event.
        <h3>8 Overall amenities</h3>
        At the event, a space will be appointed to sleep in, see section 11. This is the only place where it is permitted to place your sleeping bags. As stated in section 7, food and drinks will be fairly available. All parking lots which are open the whole weekend are for use at own risk.
        <h3>9 Media</h3>
        Recordings (including photographs) will be made at the event . No compensation can be demanded for this matter. The organization is not responsible for agreements with third parties (e.g. publication of photographs). Personal video- and audio recordings may not be used for commercial purposes. By attending this event you agree that any recording of you will be owned by the organisation of the event.
        <h3>10 Tournaments</h3>
        <h4>10.1 Registration</h4>
        After purchasing a ticket, the participant can register himself for any tournament and change the tournament registration up to one week before the starting of the event. If a tournament requires to enter as a team, one team member will make the reservation for all members and hold the rights for any changes to be made afterwards. This team member will automatically become the team captain in our system. The participant may only register for tournaments whom’s preliminary rounds do not begin at the same time. The official tournaments will always have priority over privately organised tournaments. This is done so that a participant can participate in another tournament if the participant cannot continue in the other. In case participation is possible in both tournaments, the official tournament has priority.
        <h4>10.2 Prizes</h4>
        The organization reserves the right to modify or reduce the prizes according to the amount of registrations or other interventions. The prizewinner shall be present at the ceremony and personally collect the prize, unless a substitute is made known to the organization. In case of a team being the winner of a prize, one team member will suffice in collecting the prize.
        <h3>11 Accommodations</h3>
        During the event overnight stay is possible. All participants will stay in the appointed rooms, each owning a reasonable amount of space as determined by the organization. This space will be used to sleep, thus only allowing enough room for an air mattress or something similar and a few belongings. Note that the participant is asked to take as little space as possible, meaning only single mattresses are allowed (when used by one person). Tents are not allowed inside the building, the organization will not be responsible for any violations outside the building of Cornelis Drebbelweg 5.
        <h3>12 Prohibited objects</h3>
        Any object, not directly needed for gaming, that needs electricity to function is not permitted at the event. This excludes chargers for gadgets like mobile phones.
        Below is a list of objects which are not allowed at the event due to unnecessary, safety reasons and rules. Note that any similar objects that are not listed and have the same effect are also prohibited at the event.
        coolbox
        refrigerator
        fan/air conditioner
        <h3>13 Services</h3>
        <h4>13.1 Pickup Service</h4>
        The participant can sign up for the non-free pickup service, which means the organization will transport the participants PC to the location of the event. This service is only available for participants living in a radius of 7.5 (seven and a half) kilometers of the location of the event. All PC’s will be collected on the day before the first day of the event. The participant will be noted beforehand of the moment this pickup will occur.
        For this service a few requirements must be met and if they are not, the collector may refuse to take your PC. These requirements are listed below.
        This service is for PCs and its necessary accessories only, meaning other objects will be rejected.
        The PC and accessories must be fully and neatly packed in boxes.
        Every box must consist of a label containing:
        The participant's full name and address
        The total number of boxes the participant is handing in and the current box’s number
        Note that the use of this service is under full responsibility of the participant. The organization is not liable for any inconveniences or damages as a result of the pickup service.
        <h3>14 Network and server use</h3>
        Software which is stored on the event’s server, from now on referenced to as “the server”, by participants is considered to be Shareware or Public Domain. Only one copy is permitted on the server, to be able to fully service all participants. If another copy or similar product is brought under the organization’s attention, the concerning software will be investigated and removed if necessary. 
        <h4>14.1 Liability</h4>
        The organization can not keep a permanent control on the software exchange through the server. Therefore, the organization is not responsible for possible copyrighted software which has been stored on or retrieved from the server. Nevertheless, it is illegal to reproduce any copyrighted material, without the author’s permission. Any possible illegal movement of protected software is the participant’s responsibility. The organization will not accept any liability for violating privacy. The organization ensures the participant’s privacy as far as is required legally. Hence, every participant is responsible for using any sort of software. Hereof, the organization will not accept liability for content, use or ownership. Note that all the above is nonapplicable for software provided by the organization, in that case she will take full responsibility for any inconveniences.
        <h3>15 Unspecified actions</h3>
        When a situation occurs that is not specified in this document, there will be an appropriate response. The sanction will be determined according to the severeness of the violation. The sanction is to be determined by the organization.

      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="closeDialog">Cancel</paper-button>
        <paper-button dialog-confirm on-tap="payOrder">I agree to the terms of service</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
  'use strict';
  Polymer({
    is: 'lancie-ticket-page',
    properties: {
      user: Object,
      order: {
        type: Object,
        observer: 'checkTickets'
      },
      hasNoTickets: {
        type: Boolean,
        value: true
      },
      availableTickets: {
        type: Object,
        value: []
      },
      route: {
        type: String,
        notify: true,
        observer: '_changedRoute'
      }
    },

    _changedRoute: function() {
      if (this.route !== 'tickets') {
        return;
      }

      if (!this.user) {
        return;
      }

      var missing = false;
      for (var a in this.user.profile) {
        if (a !== 'notes' && !this.user.profile[a]) {
          missing = true;
        }
      }

      if (missing) {
        this.async(function() {
          this.route = 'tickets-profile-intercept';
        });
      }

      this.canOrderTickets = !missing;
    },

    attached: function() {
      this._changedRoute();
      setTimeout(function() {
        this.classList.add('active');
      }.bind(this), 50);
    },

    payOrder: function() {
      this.$.ajax.generateRequest();
    },

    openDialog: function() {
      this.$.termsofservice.open();
    },

    closeDialog: function() {
      this.$.termsofservice.close();
    },

    patchOverlay: function(e) {
      this.insertBefore(e.target.backdropElement, e.target);
    },

    _setLayout: function(medium) {
      return 'layout flex justified ' + (medium ? 'horizontal' : 'vertical');
    },

    checkTickets: function(order) {
      if (order && order.tickets && order.tickets.length !== 0) {
        this.hasNoTickets = false;
      } else {
        this.hasNoTickets = true;
      }
    },

    goToPayment: function(event, request) {
      window.location.href = request.xhr.getResponseHeader('Location');
    },

    getOpenOrder: function(event, request) {
      this.order = request.response;
    },

    loadTickets: function(event, request) {
      this.availableTickets = request.response;
    },

    _color: function(index) {
      var options = [
        '#81C784',
        '#E57373'
      ];
      return options[index];
    },

    _formatPrice: function(price) {
      if (price % 1 === 0) {
        return price + ',-';
      } else {
        return price.toFixed(2);
      }
    }
  });
  </script>
</dom-module>
