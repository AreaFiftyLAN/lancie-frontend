<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">`

<dom-module id="lancie-ticket-block">
  <link rel="import" type="css" href="lancie-ticket-block.css">

  <template>
    <paper-material elevation="0" class="ticket-selector-block layout vertical" style$="{{_computeStyle(color)}}">
      <div class="version layout horizontal self-end">{{remaining}}</div>
      <h2>{{_ucfirst(ticket.text)}}</h2>
      <h3 class="horizontal layout start">Price: € {{price}}</h3>
      <hr themed-reverse>
      <div id="extraOptions" class="extra-options">
        <h4>Options</h4>
        <paper-checkbox checked="{{chMember}}" disabled="{{disabled}}">
          CH Member
          <span>(€ {{_formatPrice(ticket.chMemberDiscountPrice)}})</span> Discount
        </paper-checkbox><br />
        <paper-checkbox checked="{{pickup}}" disabled="{{disabled}}">
          Pickup Service
          <span>(€ {{_formatPrice(ticket.pickupServicePrice)}})</span>
        </paper-checkbox>
      </div>
      <hr themed-reverse style="margin-botton: 12px;">
      <paper-button on-tap="addTicket" disabled="{{notAvailable}}">Add</paper-button>
    </paper-material>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'lancie-ticket-block',
        properties: {
          ticket: {
            type: Object,
            notify: true
          },

          remaining: {
            type: String,
            computed: '_computeRemainingString(ticket)'
          },

          chMember: {
            type: Boolean
          },

          pickup: {
            type: Boolean
          },

          price: {
            type: String,
            computed: '_computePrice(ticket, chMember, pickup)'
          },

          disabled: {
            type: Boolean,
            value: false
          }
        },

        attached: function() {
          if (this.ticket.numberSold === this.ticket.limit) {
            this.classList.add('disabled');
            this.disabled = true;
          }

          setTimeout(function() {
            this.classList.add('active');
          }.bind(this), 50);
        },

        addTicket: function() {
          this.ticket.numberSold++;
          this.fire('add-ticket', {chMember: this.chMember, pickup: this.pickup});
        },

        _computeRemainingString: function(ticket) {
          var remaining = ticket.limit - ticket.numberSold;
          if (remaining === 0) {
            return 'SOLD OUT!';
          }
          if (ticket.text === 'Regular') {
            return 'Available!';
          }
          return remaining + ' tickets left!';
        },

        _computePrice: function(ticket, chMember, pickup) {
          var basePrice = ticket.price;

          basePrice += (chMember ? ticket.chMemberDiscountPrice : 0);
          basePrice += (pickup ? ticket.pickupServicePrice : 0);

          return this._formatPrice(basePrice);
        },

        _formatPrice: function(price) {
          if (price % 1 == 0) {
            return Math.abs(price) + ",-";
          } else {
            return Math.abs(price).toFixed(2);
          }
        },

        _ucfirst: function(str) {
          if (!str || 0 === str.length) {
            return "No Name";
          }
          var f = str.charAt(0)
                  .toUpperCase();
          return f + str.substr(1);
        },

        _computeStyle: function (color) {
          return 'background-color: ' + color;
        }
      });
    })();
  </script>
</dom-module>
