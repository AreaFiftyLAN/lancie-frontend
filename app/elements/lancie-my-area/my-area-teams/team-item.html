<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../lancie-login/lancie-ajax.html">
<link rel="import" href="team-member-item.html">
<link rel="import" href="my-area-teams-invite.html">
<dom-module id="team-item">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
    :host {
      display: block;
    }
    
    paper-dialog {
      min-width: 30%;
      /*--primary-text-color: #FEE474;*/
      --paper-dialog-button-color: #1A2B43;
    }
    
    h3.my-area-teams h3 {
      width: 40%;
    }
    
    .captain-info {
      margin-left: 5%;
    }
    
    .errormessage {
      padding: 10px 20px 9px;
      margin-bottom: 4px;
      border-left: 3px solid #F44336;
      background: #FFCDD2;
      color: #B71C1C;
    }
    </style>
    <lancie-ajax id="ajaxInviteMember" refurl="teams/{{team.id}}/invites" method="POST" handle-as="json" on-response="onInviteMember"></lancie-ajax>
    <lancie-ajax id="ajaxGetTeamInvites" refurl="teams/{{team.id}}/invites" method="GET" handle-as="json" on-response="storeTeamInvites"></lancie-ajax>
    <paper-item class="team-info">
      <paper-item-body class="layout horizontal center">
        <div class="flex-2">
          <h3>Team: {{team.teamName}}</h3></div>
        <div class="flex captain-info"><b>Captain: </b>{{team.captain.profile.displayName}}</div>
        <template is="dom-if" if="{{_isSameUser(team.captain, user)}}">
          <div>
            <paper-icon-button id="addMemberButton" icon="social:person-add" on-tap="openAddMemberDialog"></paper-icon-button>
            <paper-tooltip offset="0" for="addMemberButton" animation-delay="1">Invite a member</paper-tooltip>
            <paper-icon-button id="openInvitesButton" icon="icons:markunread-mailbox" on-tap="openTeamInvitesDialog"></paper-icon-button>
            <paper-tooltip offset="0" for="openInvitesButton" animation-delay="1">View open invites</paper-tooltip>
          </div>
        </template>
      </paper-item-body>
    </paper-item>
    <template is="dom-repeat" items="{{team.members}}" as="member">
      <team-member-item is-current-user="{{_isSameUser(member, user)}}" is-captain="{{_isSameUser(team.captain, user)}}" member="{{member}}" team={{team}}>
      </team-member-item>
    </template>
    <!-- Invite a Member dialog -->
    <paper-dialog id="addMemberDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
      <h2>Add a team member</h2>
      <paper-material class="errormessage" hidden$="{{!addMemberError}}">{{addMemberMessage}}</paper-material>
      <paper-input label="Username" type="text" value="{{memberUsername}}"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="submitInviteMember">Invite</paper-button>
      </div>
    </paper-dialog>
    <!-- Team Invite Overview Dialog -->
    <paper-dialog id="teamInvitesDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
      <h2>Your team invites</h2>
      <template is="dom-if" if="{{teamInvites.length}}">
        <template is="dom-repeat" items="{{teamInvites}}">
          <my-area-teams-invite invite="{{item}}" team on-invite-change="refreshInvites"></my-area-teams-invite>
        </template>
      </template>
      <template is="dom-if" if="{{!teamInvites.length}}">
        <p>You don't have any open invites!</p>
      </template>
      <div class="buttons">
        <paper-button dialog-dismiss>OK</paper-button>
      </div>
    </paper-dialog>
    <paper-toast id="memberInviteSuccessToast" text="User successfully invited!" duration="3000"></paper-toast>
  </template>
  <script>
  'use strict';
  Polymer({
    is: 'team-item',
    properties: {
      team: Object,
      user: Object,
      teamInvites: Array,
      addMemberError: {
        type: Boolean,
        value: false
      },
      isCurrentUser: Boolean,
      isCaptain: Boolean,
      memberUsername: String,
      addMemberMessage: String
    },
    refreshInvites: function() {
      this.$.ajaxGetTeamInvites.generateRequest();
    },
    openAddMemberDialog: function() {
      this.addMemberMessage = '';
      this.addMemberError = false;
      this.memberUsername = '';
      this.$.addMemberDialog.open();
    },
    submitInviteMember: function() {
      this.$.ajaxInviteMember.body = this.memberUsername;
      this.$.ajaxInviteMember.generateRequest();
    },
    onInviteMember: function(e, r) {
      this.addMemberError = !r.succeeded;
      if (r.succeeded) {
        this.fire('invite-success');
        this.$.addMemberDialog.close();
        this.$.memberInviteSuccessToast.show();
      } else {
        if (r.request.status === 403) {
          this.addMemberMessage = 'User can\'t be added to this team, does he/she have a ticket?';
        } else if (r.request.status === 409) {
          this.addMemberMessage = 'User is already invited for this team!';
        } else {
          this.addMemberMessage = 'Something went wrong';
        }
      }
    },
    storeTeamInvites: function(event, request) {
      this.teamInvites = request.response.length > 0 ? request.response : false;
    },
    openTeamInvitesDialog: function() {
      this.$.ajaxGetTeamInvites.generateRequest();
      this.$.teamInvitesDialog.open();
    },
    _isSameUser: function(other, user) {
      return other.reference === user.reference;
    }
  });
  </script>
</dom-module>
