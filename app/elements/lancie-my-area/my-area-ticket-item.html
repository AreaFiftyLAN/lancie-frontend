<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../lancie-dialog/lancie-dialog.html">
<dom-module id="my-area-ticket-item">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
    :host {
      display: block;
    }
    
    hr {
      display: block;
      height: 1px;
      border: 0;
      border-top: 1px solid #e8e8e8;
      padding: 0;
    }
    
    .errormessage {
      padding: 10px 20px 9px;
      margin-bottom: 4px;
      border-left: 3px solid #F44336;
      background: #FFCDD2;
      color: #B71C1C;
    }
    
    .block {
      padding: 4px 32px 4px 0;
    }
    
    .options {
      width: 40%;
    }
    
    .block > *:first-child {
      color: #737373;
      font-family: 'Roboto', 'Noto', sans-serif;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
    }
    </style>
    <lancie-ajax id="ajaxSetupTicketTransfer" refurl="tickets/transfer/{{ticket.id}}" method="POST" handle-as="json" on-response="onSetupTicketTransfer"></lancie-ajax>
    <lancie-ajax id="ajaxCancelTicketTransfer" refurl="tickets/transfer" method="DELETE" handle-as="json" on-response="onCancelTicketTransfer"></lancie-ajax>
    <hr>
    <paper-item class="layout horizontal center justified wrap" role="option" tabindex="0" aria-disabled="false">
      <div class="layout vertical block">
        <div>Ticket type:</div>
        <div>{{ticket.text}}</div>
      </div>
      <div class="layout vertical block options">
        <div>Extra options:</div>
        <div>{{_showOptions(ticket)}}</div>
      </div>
      <div class="layout vertical block">
        <div>Price:</div>
        <div>&euro; {{_format(ticket.price)}}</div>
      </div>
      <div class="layout vertical block">
        <div>Status:</div>
        <div>{{getStatus(ticket.token)}}</div>
      </div>
      <div class="layout self-center vertical">
        <paper-icon-button icon="{{getIcon(ticket.token)}}" on-tap="openTicketTransferDialog"></paper-icon-button>
        <paper-tooltip offset="0" animation-delay="1">{{getText(ticket.token)}} ticket transfer</paper-tooltip>
      </div>
    </paper-item>
    <lancie-dialog id="setupTicketTransferDialog" entry-animation="scale-up-animation" exit-animation="scale-down-animation" with-backdrop>
      <h2>Set up ticket transfer</h2>
      <div class="card-content">
        <paper-material class="errormessage" hidden$="{{!transferError}}">{{transferErrorMessage}}</paper-material>
        <paper-input label="Username" type="text" value="{{transferUsername}}"></paper-input>
      </div>
      <div class="buttons">
        <paper-button raised dialog-dismiss>Cancel</paper-button>
        <paper-button raised on-tap="setupTicketTransfer">Transfer</paper-button>
      </div>
    </lancie-dialog>
    <lancie-dialog id="cancelTicketTransferDialog" entry-animation="scale-up-animation" exit-animation="scale-down-animation" with-backdrop>
      <h2>Cancel ticket transfer</h2>
      <div class="card-content">
        <paper-material class="errormessage" hidden$="{{!transferError}}">{{transferErrorMessage}}</paper-material>
        Are you sure you want to cancel the ticket transfer?
      </div>
      <div class="buttons">
        <paper-button raised dialog-dismiss>No</paper-button>
        <paper-button raised on-tap="cancelTicketTransfer">Yes</paper-button>
      </div>
    </lancie-dialog>
    <paper-toast id="setupTicketTransferSuccessToast" text="Ticket successfully set up for transfer!" duration="3000"></paper-toast>
    <paper-toast id="cancelTicketTransferSuccessToast" text="Ticket transfer successfully cancelled!" duration="3000"></paper-toast>
  </template>
  <script>
  'use strict';

  Polymer({
    is: 'my-area-ticket-item',

    properties: {
      ticket: {
        type: Object,
        notify: true
      },
      username: String,
      transferError: {
        type: Boolean,
        value: false
      },
      transferErrorMessage: String,
      transferUsername: String
    },
    getIcon: function(token) {
      console.log(token);
      return token == undefined ? 'icons:send' : 'icons:clear';
    },
    getText: function(token) {
      return token == undefined ? 'Setup up' : 'Cancel'
    },
    getStatus: function(token) {
      return token == undefined ? 'Owned' : 'Transfering';
    },
    openTicketTransferDialog: function() {
      if (this.ticket.token) {
        this.cancelTicketTransferDialog();
      } else {
        this.setupTicketTransferDialog();
      }
    },
    setupTicketTransferDialog: function() {
      this.transferUsername = '';
      this.transferError = false;
      this.transferErrorMessage = '';
      this.$.setupTicketTransferDialog.toggle();
    },
    setupTicketTransfer: function() {
      if (!this.transferUsername || this.transferUsername.length === 0) {
        this.transferError = true;
        this.transferErrorMessage = 'Please fill in a username.';
        return;
      }
      if (this.transferUsername === this.username) {
        this.transferError = true;
        this.transferErrorMessage = 'This ticket is already yours.';
        return;
      }
      this.$.ajaxSetupTicketTransfer.body = this.transferUsername;
      this.$.ajaxSetupTicketTransfer.generateRequest();

      this.transferError = false;
      this.transferErrorMessage = '';
    },
    onSetupTicketTransfer: function(e, r) {
      if (r.succeeded) {
        this.ticket.token = r.response.object;
        this.setupTicketTransferDialog();
        this.$.setupTicketTransferSuccessToast.show();
      } else {
        this.transferError = true;
        if (r.request.status === 403) {
          this.transferErrorMessage = 'User not found.';
        } else {
          this.transferErrorMessage = 'The server was unable to process your request.';
        }
      }
    },
    cancelTicketTransferDialog: function() {
      this.$.cancelTicketTransferDialog.toggle();
    },
    cancelTicketTransfer: function() {
      this.$.ajaxCancelTicketTransfer.body = this.ticket.token;
      this.$.ajaxCancelTicketTransfer.generateRequest();
    },
    onCancelTicketTransfer: function(e, r) {
      if (r.succeeded) {
        delete this.ticket.token;
        this.cancelTicketTransferDialog();
        this.$.cancelTicketTransferSuccessToast.show();
      } else {
        this.transferError = true;
        this.transferErrorMessage = 'The server was unable to process your request.';
      }
    },
    _showOptions: function(ticket) {
      if (ticket.pickupService && ticket.chMember) {
        return 'Christiaan Huygens Member, Pickup Service';
      } else if (ticket.pickupService) {
        return 'Pickup Service';
      } else if (ticket.chMember) {
        return 'Christiaan Huygens Member';
      }

      return 'No extra options';
    },
    _format: function(money) {
      var n = money,
        c = 2,
        d = ",",
        t = ".",
        s = n < 0 ? "-" : "",
        i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "",
        j = (j = i.length) > 3 ? j % 3 : 0;
      return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
    }
  });
  </script>
</dom-module>
