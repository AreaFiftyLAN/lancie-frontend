<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../lancie-login/lancie-ajax.html">


<dom-module id="my-area-profile">
  <template>
    <style>
    :host {
      display: block;
    }
    
    paper-card {
      width: 100%;
    }
    
    paper-tooltip {
      --paper-tooltip-background: #1A2B43;
      --paper-tooltip-text-color: #FEE474;
    }
    
    paper-input {
      margin: 0 10px 0 10px;
    }
    
    #checkIcon {
      --iron-icon-fill-color: #4CAF50;
    }
    
    #closeIcon {
      --iron-icon-fill-color: #F44336;
    }
    
    hr {
      display: block;
      height: 1px;
      border: 0;
      border-top: 1px solid #e8e8e8;
      margin: 1em 0;
      padding: 0;
    }
    </style>

    <lancie-ajax
    id="ajaxUpdateProfile"
    refurl="users/current/profile"
    method="POST"
    on-response="onProfileUpdate"></lancie-ajax>

    <lancie-ajax
    id="ajaxUpdatePassword"
    refurl="users/current/password"
    method="PUT"></lancie-ajax>

    <paper-card elevation="1" animated-shadow="true">
      <div class="card-content">
        <div class="title">Profile</div>
        <div class="list" role="listbox">
          <template is="dom-if" if="{{!editingProfile}}">
            <paper-icon-item>
              <iron-icon icon="icons:account-circle" item-icon></iron-icon>
              <paper-item-body two-line>
                <div>{{user.profile.displayName}}</div>
                <div>{{user.profile.firstName}} {{user.profile.lastName}}</div>
              </paper-item-body>
            </paper-icon-item>
            <paper-icon-item>
              <iron-icon icon="communication:phone" item-icon></iron-icon>
              <paper-item-body>
                <div>{{user.profile.phoneNumber}}</div>
              </paper-item-body>
            </paper-icon-item>
            <paper-icon-item>
              <iron-icon icon="communication:location-on" item-icon></iron-icon>
              <paper-item-body two-line>
                <div>{{user.profile.address}}</div>
                <div>{{user.profile.zipcode}} {{user.profile.city}}</div>
              </paper-item-body>
            </paper-icon-item>
          </template>
          <template is="dom-if" if="{{editingProfile}}">
            <paper-icon-item>
              <iron-icon icon="icons:account-circle" item-icon></iron-icon>
              <paper-item-body two-line>
                <paper-input label="Display Name" type="text" value="{{editingUser.profile.displayName}}"></paper-input>
                <div class="layout horizontal wrap">
                  <paper-input label="First Name" type="text" value="{{editingUser.profile.firstName}}" class="flex"></paper-input>
                  <paper-input label="Last Name" type="text" value="{{editingUser.profile.lastName}}" class="flex"></paper-input>
                </div>
              </paper-item-body>
            </paper-icon-item>
            <paper-icon-item>
              <iron-icon icon="communication:phone" item-icon></iron-icon>
              <paper-item-body>
                <paper-input label="Phone Number" type="text" value="{{editingUser.profile.phoneNumber}}"></paper-input>
              </paper-item-body>
            </paper-icon-item>
            <paper-icon-item>
              <iron-icon icon="communication:location-on" item-icon></iron-icon>
              <paper-item-body two-line>
                <div class="layout horizontal wrap">
                  <paper-input label="Address" type="text" value="{{editingUser.profile.address}}" class="flex-3"></paper-input>
                  <paper-input label="Zipcode" type="text" value="{{editingUser.profile.zipcode}}" class="flex"></paper-input>
                  <paper-input label="City" type="text" value="{{editingUser.profile.city}}" class="flex-3"></paper-input>
                </div>
              </paper-item-body>
            </paper-icon-item>
          </template>
          <hr>
            <paper-icon-item>
              <iron-icon icon="communication:email" item-icon></iron-icon>
              <paper-item-body>
                <div>{{user.email}}</div>
              </paper-item-body>
            </paper-icon-item>
          <hr>
          <template is="dom-if" if="{{!editingPassword}}">
            <paper-icon-item>
              <iron-icon icon="icons:lock" item-icon></iron-icon>
              <paper-item-body>
                <div>&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;</div>
              </paper-item-body>
            </paper-icon-item>
          </template>
          <template is="dom-if" if="{{editingPassword}}">
            <paper-icon-item>
              <iron-icon icon="icons:lock" item-icon></iron-icon>
              <paper-item-body>
                <paper-input label="currentPassword" type="password"></paper-input>
                <paper-input label="newPassword" type="password"></paper-input>
                <paper-input label="newPasswordRepeat" type="password"></paper-input>
              </paper-item-body>
            </paper-icon-item>
          </template>
          <hr>
        </div>
        <div class="card-actions">
          <template is="dom-if" if="{{!isEditing(editingProfile, editingPassword)}}">
            <paper-icon-button on-tap="switchProfileForm" icon="icons:create" id="edit-profile"></paper-icon-button>
            <paper-tooltip for="edit-profile" offset="0" animation-delay="1">Edit your profile</paper-tooltip>
            <paper-icon-button on-tap="switchPasswordForm" icon="icons:lock" id="change-password"></paper-icon-button>
            <paper-tooltip for="change-password" offset="0" animation-delay="1">Change your password</paper-tooltip>
          </template>
          <template is="dom-if" if="{{isEditing(editingProfile, editingPassword)}}">
            <paper-icon-button on-tap="resetForms" icon="icons:clear" id="closeIcon"></paper-icon-button>
            <paper-tooltip for="closeIcon" offset="0" animation-delay="1">Cancel</paper-tooltip>
            <paper-icon-button on-tap="submitEdit" icon="icons:check" id="checkIcon"></paper-icon-button>
            <paper-tooltip for="checkIcon" offset="0" animation-delay="1">Save changes</paper-tooltip>
          </template>
        </div>
      </div>
    </paper-card>
  </template>
  <script>
  (function() {
    var lastUser;
    Polymer({
      is: 'my-area-profile',
      properties: {
        user: {
          type: Object,
          observer: '_copyUser'
        },
        editingUser: {
          type: Object
        },
        editingProfile: {
          type: Boolean,
          value: false
        },
        editingPassword: {
          type: Boolean,
          value: false
        }
      },
      switchProfileForm: function() {
        this.editingProfile = !this.editingProfile;
      },
      switchPasswordForm: function() {
        this.editingPassword = !this.editingPassword;
      },
      resetForms: function() {
        this.editingProfile = false;
        this.editingPassword = false;
      },
      submitEdit: function() {
        // this.user = this.editingUser;

        if(this.editingProfile){
          this.$.ajaxUpdateProfile.body = {
            displayName: this.editingUser.profile.displayName,
            firstName: this.editingUser.profile.firstName,
            lastName: this.editingUser.profile.lastName,
            phoneNumber: this.editingUser.profile.phoneNumber,
            address: this.editingUser.profile.address,
            zipcode: this.editingUser.profile.zipcode,
            city: this.editingUser.profile.city,
            gender: this.editingUser.profile.gender
          };
          this.$.ajaxUpdateProfile.generateRequest();
          this.switchProfileForm();
        }

        if(this.editingPassword){
          this.ajaxUpdatePassword.$.body = {

          }
          this.$.ajaxUpdatePassword.generateRequest();
          this.switchPasswordForm();
        }

      },
      onProfileUpdate: function(e, response){
        console.log(response.status);
        if(response.succeeded){
          this.user = this.editingUser;
          // load toast
        } else {
          console.log("Update profile failed");
          // load failed toast
        }
      },
      isEditing: function(editingProfile, editingPassword) {
        return editingProfile || editingPassword;
      },
      _copyUser: function(newValue) {
        var user = {
          profile: {}
        };

        for (var a in newValue.profile) {
          user.profile[a] = newValue.profile[a];
        }
        user.email = newValue.email;
        this.editingUser = user;
      }
    });
  })();
  </script>
</dom-module>
